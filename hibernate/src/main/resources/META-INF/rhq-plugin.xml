<?xml version="1.0" encoding="UTF-8" ?>

<plugin name="Hibernate"
        displayName="Hibernate Services"
        package="org.rhq.plugins.hibernate"
        description="Provides monitoring of Hibernate session manager statistics, EJB3 entities and queries"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="urn:xmlns:rhq-plugin"
        xmlns:c="urn:xmlns:rhq-configuration">

   <depends plugin="JMX" />
   <depends plugin="Tomcat" />
   <depends plugin="JBossAS" useClasses="true"/>


   <service name="Hibernate Statistics"
      discovery="org.rhq.plugins.jmx.MBeanResourceDiscoveryComponent"
      class="StatisticsComponent"
      description="Statistics for Hibernate">

      <runs-inside>
         <parent-resource-type name="JMX Server" plugin="JMX"/>
         <parent-resource-type name="Tomcat Server" plugin="Tomcat"/>
         <parent-resource-type name="JBossAS Server" plugin="JBossAS"/>
      </runs-inside>

      <plugin-configuration>
         <c:simple-property name="objectName" readOnly="true" default="Hibernate:application=%application%,type=statistics"/>
         <c:simple-property name="nameTemplate" default="{application} Hibernate statistics"/>
         <c:simple-property name="descriptionTemplate" default="Hibernate statistics for the {application} application."/>
         <c:simple-property name="application" type="string" description="the Hibernate application name"/>
      </plugin-configuration>

      <operation name="clear" displayName="Clear Statistics" description="Clear the collected statistics and begin collecting again"/>

      <operation name="viewQueries" description="View statistical information about queries executed by Hibernate">
         <results>
            <c:list-property name="queries">
               <c:map-property name="query">
                  <c:simple-property name="query" summary="true"/>
                  <c:simple-property name="executionCount" summary="true" type="integer"/>
                  <c:simple-property name="executionRowCount" summary="true" type="integer"/>
                  <c:simple-property name="executionMinTime" summary="true" type="integer"/>
                  <c:simple-property name="executionMaxTime" summary="true" type="integer"/>
                  <c:simple-property name="executionAvgTime" summary="true" type="integer"/>
               </c:map-property>
            </c:list-property>
         </results>
      </operation>

      <metric displayName="Entity Insert Count" property="EntityInsertCount"
              category="throughput" displayType="summary" measurementType="trendsup"/>

      <metric displayName="Query Execution Max Time" property="QueryExecutionMaxTime"
              category="performance" displayType="summary"/>

      <metric displayName="Entity Update Count" property="EntityUpdateCount"
              category="throughput" measurementType="trendsup"/>

      <metric displayName="Collection Update Count" property="CollectionUpdateCount"
              category="throughput" measurementType="trendsup"/>

      <metric displayName="Entity Load Count" property="EntityLoadCount"
              category="throughput" measurementType="trendsup"/>

      <metric displayName="Entity Fetch Count" property="EntityFetchCount" category="throughput"
              displayType="summary" measurementType="trendsup"/>

      <metric displayName="Entity Delete Count" property="EntityDeleteCount"
              category="throughput" measurementType="trendsup"/>

      <metric displayName="Collection Recreate Count" property="CollectionRecreateCount"
              category="throughput" measurementType="trendsup"/>

      <metric displayName="Query Execution Count" property="QueryExecutionCount"
              category="throughput" displayType="summary" measurementType="trendsup"/>

      <metric displayName="Flush Count" property="FlushCount"
              category="throughput" measurementType="trendsup"/>

      <metric displayName="Collection Load Count" property="CollectionLoadCount"
              category="throughput" measurementType="trendsup"/>

      <metric displayName="Successful Transaction Count" property="SuccessfulTransactionCount"
              category="throughput" defaultOn="true" measurementType="trendsup"/>

      <metric displayName="Query Cache Hit Count" property="QueryCacheHitCount"
              category="throughput" measurementType="trendsup"/>

      <metric displayName="Collection Remove Count" property="CollectionRemoveCount"
              category="throughput" measurementType="trendsup"/>

      <metric displayName="Connect Count" property="ConnectCount"
              category="throughput" defaultOn="true" measurementType="trendsup"/>

      <metric displayName="Start Time" property="StartTime" dataType="trait"
              category="availability" defaultOn="true" units="epoch_milliseconds" measurementType="dynamic"/>

      <metric displayName="Second Level Cache Put Count" property="SecondLevelCachePutCount"
              category="throughput" measurementType="trendsup"/>

      <metric displayName="Query Cache Put Count" property="QueryCachePutCount"
              category="throughput" measurementType="trendsup"/>

      <metric displayName="Session Open Count" property="SessionOpenCount"
              category="throughput" defaultOn="true" measurementType="trendsup"/>

      <metric displayName="Transaction Count" property="TransactionCount"
              category="throughput" defaultOn="true" measurementType="trendsup"/>

      <metric displayName="Collection Fetch Count" property="CollectionFetchCount"
              category="throughput" measurementType="trendsup"/>

      <metric displayName="Session Close Count" property="SessionCloseCount"
              category="throughput" defaultOn="true" measurementType="trendsup"/>

      <metric displayName="Query Cache Miss Count" property="QueryCacheMissCount"
              category="throughput" defaultOn="true" measurementType="trendsup"/>

      <metric displayName="Second Level Cache Miss Count" property="SecondLevelCacheMissCount"
              category="throughput" measurementType="trendsup"/>

      <help>
         <![CDATA[
          In order to monitor Hibernate statistics via JON, the Hibernate Session Manager MBean
          must be deployed to an object name of the format _"Hibernate:application=%application%,type=statistics"_,
          and statistics must be enabled.

          Some example code is provided below to register the Hibernate Session MBean within an EJB3 application.
          {code}
 public static void enableHibernateStatistics(EntityManager entityManager)
 {
    try
    {
       StatisticsService mBean = new StatisticsService();
       SessionFactory sessionFactory = getHibernateSession(entityManager).getSessionFactory();
       mBean.setSessionFactory(sessionFactory);
       ObjectName objectName = new ObjectName(HIBERNATE_STATISTICS_MBEAN_OBJECTNAME);
       MBeanServer jbossMBeanServer = getJBossMBeanServer();
       jbossMBeanServer.registerMBean(mBean, objectName);
       sessionFactory.getStatistics().setStatisticsEnabled(true);
    }
    catch (InstanceAlreadyExistsException iaee)
    {
       LOG.info("Duplicate MBean registration ignored: " + HIBERNATE_STATISTICS_MBEAN_OBJECTNAME);
    }
    catch (Exception e)
    {
       LOG.warn("Couldn't register Hibernate statistics MBean.", e);
    }
 }

 private static Session getHibernateSession(EntityManager entityManager) {
    Session session;
    if (entityManager.getDelegate() instanceof EntityManagerImpl) {
        EntityManagerImpl entityManagerImpl = (EntityManagerImpl) entityManager.getDelegate();
        session = entityManagerImpl.getSession();
    } else {
        session = (Session) entityManager.getDelegate();
    }
    return session;
 }

 private static MBeanServer getJBossMBeanServer() {
    List<MBeanServer> servers = MBeanServerFactory.findMBeanServer(null);
    MBeanServer jbossServer = null;
    for (MBeanServer server : servers) {
        if ("jboss".equals(server.getDefaultDomain())) {
            jbossServer = server;
        }
    }
    if (jbossServer == null) {
        jbossServer = ManagementFactory.getPlatformMBeanServer();
    }
    return jbossServer;
 }
          {code}
          See also http://hibernate.org/216.html and
          http://www.redhat.com/docs/manuals/jboss/jboss-eap-4.3/doc/hibernate/Hibernate_Reference_Guide/Optional_configuration_properties-Hibernate_statistics.html
         ]]>
      </help>

      <service name="Hibernate Entity"
         discovery="EntityDiscoveryComponent"
         class="EntityComponent"
         description="A Hibernate persistent entity">

         <metric displayName="Load Count" property="loadCount" displayType="summary"/>
         <metric displayName="Update Count" property="updateCount" displayType="summary"/>
         <metric displayName="Insert Count" property="insertCount" displayType="summary"/>
         <metric displayName="Delete Count" property="deleteCount" displayType="summary"/>
         <metric displayName="Fetch Count" property="fetchCount"/>
         <metric displayName="Optimistic Lock Failure Count" property="optimisticFailureCount"/>

      </service>

   </service>

</plugin>
