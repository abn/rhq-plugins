<?xml version="1.0" encoding="UTF-8" ?>

<plugin
   name="Tomcat"
   displayName="Tomcat Server"
   package="org.jboss.on.plugins.tomcat"
   description="Supports management and monitoring of JBoss EWS or Apache Tomcat5, Tomcat6"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xmlns="urn:xmlns:rhq-plugin"
   xmlns:c="urn:xmlns:rhq-configuration">

   <depends plugin="JMX" />

   <server
      name="Tomcat Server"
      discovery="TomcatDiscoveryComponent"
      class="TomcatServerComponent"
      description="Tomcat Server">

      <plugin-configuration>
         <c:group
            name="connection"
            displayName="Connection Info">
            <c:simple-property
               name="installationPath"
               displayName="Installation Home"
               type="directory"
               readOnly="true"
               description="The home directory path of the Tomcat installation." />
            <c:simple-property
               name="connectorAddress"
               displayName="Manager URL"
               description="The RMI URL with which to connect to the Tomcat Server (e.g. service:jmx:rmi:///jndi/rmi://localhost:8999/jmxrmi)."
               default="service:jmx:rmi:///jndi/rmi://localhost:8999/jmxrmi" />
            <c:simple-property
               name="principal"
               required="false"
               description="The name of the principal (i.e. user) to authenticate." />
            <c:simple-property
               name="credentials"
               type="password"
               required="false"
               description="The credentials (i.e. password) that should be used to authenticate the principal." />
         </c:group>

         <c:group
            name="control"
            displayName="Operations">
            <c:simple-property
               name="scriptPrefix"
               displayName="Script Prefix"
               type="string"
               required="false"
               description="A prefix applied to script execution commands. Typically a sudo
                                            for applicable platforms. The prefix is applied verbatim. As such, a
                                            sudo user must be configured appropriately. Ignored if not set." />
            <c:simple-property
               name="startScript"
               displayName="Start Script"
               type="file"
               required="false"
               description="The path to the script used by the 'Start' operation to start this Tomcat server;                                            
                                            if the path is not absolute it will be resolved relative to {installationPath}." />
            <c:simple-property
               name="shutdownScript"
               displayName="Shutdown Script"
               type="file"
               required="false"
               description="The path to the script used by the 'Shutdown' operation to shutdown this Tomcat server;                                            
                                            if the path is not absolute it will be resolved relative to {installationPath}." />
         </c:group>

         <c:group
            name="advanced"
            displayName="Advanced"
            hiddenByDefault="true">
            <c:simple-property
               name="type"
               description="The type used to establish the EMS connection to the Tomcat server."
               default="org.mc4j.ems.connection.support.metadata.Tomcat55ConnectionTypeDescriptor" />
         </c:group>
      </plugin-configuration>

      <!--  This will pick up any Tomcat process, whether standalone or embedded. We narrow it down further by examining the command line -->
      <process-scan
         name="Tomcat"
         query="process|basename|match=^java.*,arg|org.apache.catalina.startup.Bootstrap|match=.*" />

      <operation
         name="start"
         displayName="Start"
         description="Start this Tomcat server. The script used is specified in Control Properties." />

      <operation
         name="shutdown"
         displayName="Shutdown"
         description="Shutdown this Tomcat server. The script used is specified in Control Properties." />

      <operation
         name="restart"
         displayName="Restart"
         description="Restart this Tomcat server. The script used is specified in Control Properties." />

      <metric
         displayName="Server Identifier"
         property="Catalina:type=Server:serverInfo"
         dataType="trait"
         displayType="summary"
         description="Tomcat server release identifier" />

      <service
         name="Tomcat Virtual Host"
         discovery="TomcatVHostDiscoveryComponent"
         class="TomcatVHostComponent"
         description="A virtual host in the web container">

         <plugin-configuration>
            <c:group
               name="general"
               displayName="General">

               <c:simple-property
                  name="objectName"
                  readOnly="true"
                  default="Catalina:type=Host,host=%name%" />
               <c:simple-property
                  name="name"
                  type="string"
                  description="The virtual host"
                  readOnly="true" />
               <c:simple-property
                  name="appBase"
                  required="true"
                  readOnly="true"
                  description="The Application Base directory for this virtual host." />                  
            </c:group>

            <c:group
               name="advanced"
               displayName="Advanced"
               hiddenByDefault="true">
               <c:simple-property
                  name="nameTemplate"
                  default="Tomcat VHost ({name})" />
               <c:simple-property
                  name="descriptionTemplate"
                  default="A Tomcat virtual host" />
            </c:group>
         </plugin-configuration>

         <operation
            name="addAlias"
            description="Add an alias name mapped to this Host.">
            <parameters>
               <c:simple-property
                  name="alias"
                  displayName="Alias"
                  description="The alias to add."
                  type="string"
                  required="true" />
            </parameters>
         </operation>

         <operation
            name="removeAlias"
            description="Remove an alias currently mapped to this Host.">
            <parameters>
               <c:simple-property
                  name="alias"
                  displayName="Alias"
                  description="The alias to remove."
                  type="string"
                  required="true" />
            </parameters>
         </operation>

         <metric
            property="Catalina:type=Host,host=%name%:aliases"
            displayName="Aliases"
            defaultOn="true"
            dataType="trait" />

         <resource-configuration>
            <c:group name="Attributes">
               <c:simple-property
                  name="autoDeploy"
                  type="boolean"
                  description="Does this host deploy new applications dropped in appBase at runtime?" />
               <c:simple-property
                  name="deployOnStartup"
                  type="boolean"
                  description="Does this host deploy applications in appBase at startup?" />
               <c:simple-property
                  name="unpackWARs"
                  type="boolean"
                  description="Does this Host automatically unpack deployed WAR files?" />
            </c:group>
         </resource-configuration>

         <service
            name="Tomcat Web Application (WAR)"
            discovery="TomcatWarDiscoveryComponent"
            class="TomcatWarComponent"
            description="Tomcat deployed Web Application"
            createDeletePolicy="both"
            creationDataType="content">

            <plugin-configuration>
               <c:group name="General">
                  <c:simple-property
                     name="objectName"
                     readOnly="true"
                     default="Catalina:j2eeType=WebModule,name=%name%,J2EEApplication=none,J2EEServer=none" />
                  <c:simple-property
                     name="name"
                     readOnly="true"
                     description="The name of this Web Module (WAR)" />
                  <c:simple-property
                     name="filename"
                     readOnly="true"
                     description="The deployment root file name (.war or directory)" />
                  <c:simple-property
                     name="contextRoot"
                     readOnly="true"
                     required="false"
                     description="The unique path prefix for URLs corresponding to this WAR" />
                  <c:simple-property
                     name="vHost"
                     displayName="Virtual Host"
                     readOnly="true"
                     required="false"
                     description="The (virtual) host that this application is running on. If no virtual host is set, this defaults to 'localhost'" />
               </c:group>

               <c:group name="ResponseTime">
                  <c:simple-property
                     name="responseTimeLogFile"
                     required="false"
                     description="the absolute path to the log file containing response-time statistics for this web application" />
                  <c:simple-property
                     name="responseTimeUrlExcludes"
                     required="false"
                     description="a space-delimited list of regular expressions matching URLs to exclude from response-time statisics" />
                  <c:simple-property
                     name="responseTimeUrlTransforms"
                     required="false"
                     description="a space-delimited list of Perl-style substitution expressions to apply to URLs actively collecting response-time statistics (e.g. |^/dept/finance/.*|/dept/finance/*|)" />
               </c:group>

               <c:group
                  name="Advanced"
                  hiddenByDefault="true">
                  <c:simple-property
                     name="nameTemplate"
                     default="Tomcat WAR ({name})" />
                  <c:simple-property
                     name="extension"
                     default="war"
                     readOnly="true" />
                  <c:simple-property
                     name="descriptionTemplate"
                     default="Tomcat Web Application"
                     readOnly="true" />
               </c:group>
            </plugin-configuration>

            <operation
               name="start"
               description="starts this web application." />

            <operation
               name="stop"
               description="stops this web application." />

            <operation
               name="reload"
               description="reloads this web application." />

            <!-- The two traits below are collected by the ApplicationComponent class, which WarComponent extends.. -->
            <metric
               property="Application.exploded"
               displayName="Exploded deployment"
               dataType="trait"
               displayType="summary"
               description="Whether deployed as a .war file or an exploded directory" />

            <metric
               property="Servlet.NumRequests"
               displayName="Requests served"
               units="none"
               description="Number of requests served by servlets"
               measurementType="trendsup"
               displayType="summary" />

            <metric
               property="Servlet.NumErrors"
               displayName="Errors while processing"
               units="none"
               description="Number of errors while processing"
               measurementType="trendsup"
               displayType="summary" />

            <metric
               property="Session.activeSessions"
               displayName="Currently Active Sessions"
               units="none"
               description="Number active sessions for the webapp right now" />

            <metric
               property="Session.maxActive"
               displayName="Maximum number of Active Sessions"
               units="none"
               description="Maximum number of active sessions for the webapp" />

            <metric
               property="Session.sessionCounter"
               displayName="Sessions created"
               units="none"
               description="Number of sessions created for the webapp"
               measurementType="trendsup" />

            <metric
               property="Session.expiredSessions"
               displayName="Expired Sessions"
               units="none"
               description="Number of expired sessions for the webapp"
               measurementType="trendsup" />

            <metric
               property="Session.rejectedSessions"
               displayName="Rejected Sessions"
               units="none"
               description="Number of sessions rejected for the webapp"
               measurementType="trendsup" />

            <metric
               property="Session.sessionAverageAliveTime"
               displayName="Session Average alive time"
               units="seconds"
               description="Average alive time of a Sessions" />

            <metric
               property="Session.sessionMaxAliveTime"
               displayName="Max Session alive time"
               units="seconds"
               description="Maximum alive time of a Sessions" />

            <metric
               property="VHost.name"
               displayName="Virtual Hosts"
               dataType="trait"
               defaultOn="true"
               description="Virtual hosts this app runs on" />

            <metric
               property="ResponseTime"
               displayName="HTTP Response Time"
               dataType="calltime"
               defaultOn="false"
               units="milliseconds"
               destinationType="URL"
               description="the minimum, maximum, and average response times for HTTP requests serviced by this web application" />

            <content
               name="file"
               displayName="WAR File"
               category="deployable"
               isCreationType="true">

               <configuration>
                  <c:group
                     name="deployment"
                     displayName="Deployment Options">
                     <c:simple-property
                        name="vHost"
                        displayName="Virtual Host"
                        type="string"
                        default="localhost"
                        required="false"
                        description="The virtual host to which this web application will be deployed. Default is localhost." />
                     <c:simple-property
                        name="explodeOnDeploy"
                        displayName="Explode on Deploy"
                        type="boolean"
                        default="true"
                        required="true"
                        description="If yes then explode the WAR file into the Tomcat deploy directory. If no leave as a .war file (for no, unpackWARs=false is required on the virtual host)." />
                  </c:group>
               </configuration>
            </content>

            <resource-configuration>
               <c:group name="Attributes">
                  <c:simple-property
                     name="docBase"
                     readOnly="true"
                     required="true"
                     description="The docBase set for this application" />
               </c:group>
            </resource-configuration>

            <service
               name="Tomcat Cache"
               discovery="TomcatCacheDiscoveryComponent"
               class="TomcatCacheComponent"
               description="A Tomcat Application (WAR) Cache">

               <plugin-configuration>
                  <c:group name="General">
                     <c:simple-property
                        name="objectName"
                        readOnly="true"
                        default="Catalina:type=Cache,host=%host%,path=%path%" />
                     <c:simple-property
                        name="host"
                        description="The VHost for the cache"
                        readOnly="true" />
                     <c:simple-property
                        name="path"
                        description="The relevant application path"
                        readOnly="true" />
                  </c:group>

                  <c:group
                     name="Advanced"
                     hiddenByDefault="true">
                     <c:simple-property
                        name="nameTemplate"
                        default="Tomcat Cache ({host}{path})" />
                     <c:simple-property
                        name="descriptionTemplate"
                        default="Tomcat Web Application Cache"
                        readOnly="true" />
                  </c:group>
               </plugin-configuration>

               <metric
                  property="accessCount"
                  displayType="summary"
                  description="Number of cache accesses" />
               <metric
                  property="hitsCount"
                  displayType="summary"
                  description="Number of cache hits" />
               <metric
                  property="cacheSize"
                  displayType="summary"
                  description="Number of cache entries" />
               <metric
                  property="cacheMaxSize"
                  displayType="summary"
                  description="Maximum number of cache entries" />
            </service>
         </service>

      </service>

      <service
         name="Tomcat Connector"
         discovery="TomcatConnectorDiscoveryComponent"
         class="TomcatConnectorComponent">

         <plugin-configuration>
            <c:group
               name="general"
               displayName="General">
               <c:simple-property
                  name="objectName"
                  readOnly="true"
                  default="Catalina:type=Connector,port=%port%" />
               <c:simple-property
                  name="address"
                  type="string"
                  description="IP Address on which this connector listens."
                  readOnly="true" />
               <c:simple-property
                  name="port"
                  type="string"
                  description="Port on which this connector listens."
                  readOnly="true" />
               <c:simple-property
                  name="scheme"
                  type="string"
                  description="Protocol scheme. (jk, ajp, http)."
                  readOnly="true"
                  default="http" />
               <c:simple-property
                  name="protocol"
                  type="string"
                  description="Protocol handler."
                  readOnly="true" />
            </c:group>

            <c:group
               name="advanced"
               displayName="Advanced"
               hiddenByDefault="true">
               <c:simple-property
                  name="nameTemplate"
                  default="Tomcat Connector ({scheme}-{port})" />
               <c:simple-property
                  name="descriptionTemplate"
                  default="A Tomcat connector" />
            </c:group>
         </plugin-configuration>

         <operation
            name="start"
            displayName="Start"
            description="Starts this connector" />

         <operation
            name="stop"
            displayName="Stop"
            description="Stops this connector" />

         <operation
            name="pause"
            displayName="Pause"
            description="Pauses this connector" />

         <operation
            name="resume"
            displayName="Resume"
            description="Resumes this connector" />

         <metric
            property="Catalina:type=GlobalRequestProcessor,name=%scheme%-%port%:maxTime"
            displayName="Maximum Request Time"
            description="Maximum time it took to process a request"
            units="milliseconds"
            defaultOn="true"
            category="performance" />

         <metric
            property="Catalina:type=GlobalRequestProcessor,name=%scheme%-%port%:requestCount"
            displayName="Request count"
            description="Total number of requests processed since last restart."
            defaultOn="false"
            category="utilization"
            measurementType="trendsup" />

         <metric
            property="Catalina:type=GlobalRequestProcessor,name=%scheme%-%port%:errorCount"
            displayName="Error count"
            description="Number of errors while processing since last restart."
            defaultOn="true"
            category="utilization"
            measurementType="trendsup" />

         <metric
            property="Catalina:type=ThreadPool,name=%scheme%-%port%:currentThreadsBusy"
            displayName="Threadpool Threads Active"
            defaultOn="true"
            category="utilization"
            displayType="summary" />

         <metric
            property="Catalina:type=ThreadPool,name=%scheme%-%port%:currentThreadCount"
            displayName="Threadpool Threads Allocated"
            defaultOn="true"
            category="utilization"
            displayType="summary" />

         <metric
            property="Catalina:type=ThreadPool,name=%name%:maxThreads"
            displayName="Threadpool Max Threads"
            defaultOn="true"
            category="utilization"
            displayType="detail" />
      </service>

      <service
         name="Tomcat User Database"
         discovery="org.rhq.plugins.jmx.MBeanResourceDiscoveryComponent"
         class="TomcatUserDatabaseComponent"
         description="Tomcat User Database">

         <plugin-configuration>
            <c:group name="General">
               <c:simple-property
                  name="objectName"
                  readOnly="true"
                  default="Users:type=UserDatabase,database=UserDatabase" />
            </c:group>

            <c:group
               name="Advanced"
               hiddenByDefault="true">
               <c:simple-property
                  name="nameTemplate"
                  default="Tomcat User Database" />
               <c:simple-property
                  name="descriptionTemplate"
                  default="A Tomcat User Database"
                  readOnly="true" />
            </c:group>
         </plugin-configuration>

         <operation
            name="save"
            description="Save current users and groups to persistent storage.">
         </operation>

         <service
            name="Tomcat Group"
            discovery="org.rhq.plugins.jmx.MBeanResourceDiscoveryComponent"
            class="org.rhq.plugins.jmx.MBeanResourceComponent"
            description="Tomcat User Group"
            createDeletePolicy="both"
            creationDataType="configuration">            

            <plugin-configuration>
               <c:group name="General">
                  <c:simple-property
                     name="objectName"
                     readOnly="true"
                     default="Users:type=Group,groupname=%groupname%,database=UserDatabase" />
               </c:group>

               <c:group
                  name="Advanced"
                  hiddenByDefault="true">
                  <c:simple-property
                     name="nameTemplate"
                     default="Tomcat Group ({groupname})" />
                  <c:simple-property
                     name="descriptionTemplate"
                     default="A Tomcat Group"
                     readOnly="true" />                     
               </c:group>
            </plugin-configuration>

            <operation
               name="addRole"
               description="Add a Role to this Group.">
               <parameters>
                  <c:simple-property
                     name="rolename"
                     displayName="Role Name"
                     description="The Role to add."
                     type="string"
                     required="true" />
               </parameters>               
            </operation>

            <operation
               name="removeRole"
               description="Remove the specified Role from this Group.">
               <parameters>
                  <c:simple-property
                     name="rolename"
                     displayName="Role Name"
                     description="The Role to remove."
                     type="string"
                     required="true" />
               </parameters>
            </operation>

            <resource-configuration>
               <c:group name="Attributes">
                  <c:simple-property
                     name="groupname"
                     required="true"
                     readOnly="true"
                     description="The Group name." />
                  <c:simple-property
                     name="description"
                     required="false"
                     description="The Group description." />
               </c:group>
            </resource-configuration>
         </service>

         <service
            name="Tomcat Role"
            discovery="org.rhq.plugins.jmx.MBeanResourceDiscoveryComponent"
            class="TomcatRoleComponent"
            description="Tomcat User Role"
            createDeletePolicy="both"
            creationDataType="configuration">            

            <plugin-configuration>
               <c:group name="General">
                  <c:simple-property
                     name="objectName"
                     readOnly="true"
                     default="Users:type=Role,rolename=%rolename%,database=UserDatabase" />
                  <c:simple-property
                     name="rolename"
                     required="true"                     
                     readOnly="true"
                     description="The Role name." />
                  <c:simple-property
                     name="description"
                     description="A description of the Role." />                     
               </c:group>

               <c:group
                  name="Advanced"
                  hiddenByDefault="true">
                  <c:simple-property
                     name="nameTemplate"
                     default="Tomcat Role ({rolename})" />
                  <c:simple-property
                     name="descriptionTemplate"
                     default="A Tomcat Role"
                     readOnly="true" />                     
               </c:group>
            </plugin-configuration>

            <resource-configuration>
               <c:group name="Attributes">
                  <c:simple-property
                     name="description"
                     required="false"
                     description="The Role description." />
               </c:group>
            </resource-configuration>
         </service>

         <service
            name="Tomcat User"
            discovery="org.rhq.plugins.jmx.MBeanResourceDiscoveryComponent"
            class="TomcatUserComponent"
            description="Tomcat User"
            createDeletePolicy="both"
            creationDataType="configuration">            

            <plugin-configuration>
               <c:group name="General">
                  <c:simple-property
                     name="objectName"
                     readOnly="true"
                     default="Users:type=User,username=%username%,database=UserDatabase" />
                  <c:simple-property
                     name="username"
                     readOnly="true"
                     required="true"                     
                     description="The User name." />
               </c:group>

               <c:group
                  name="Advanced"
                  hiddenByDefault="true">
                  <c:simple-property
                     name="nameTemplate"
                     default="Tomcat User ({username})" />
                  <c:simple-property
                     name="descriptionTemplate"
                     default="A Tomcat User"
                     readOnly="true" />
               </c:group>
            </plugin-configuration>

            <operation
               name="addGroup"
               description="Add the User to the specified Group.">
               <parameters>
                  <c:simple-property
                     name="groupname"
                     displayName="Group Name"
                     description="The Group to add."
                     type="string"
                     required="true" />
               </parameters>
            </operation>

            <operation
               name="removeGroup"
               description="Remove the User from the specified Group.">
               <parameters>
                  <c:simple-property
                     name="groupname"
                     displayName="Group Name"
                     description="The Group to remove."
                     type="string"
                     required="true" />
               </parameters>
            </operation>

            <operation
               name="addRole"
               description="Add the specified Role to the User.">
               <parameters>
                  <c:simple-property
                     name="rolename"
                     displayName="Role Name"
                     description="The Role to add."
                     type="string"
                     required="true" />
               </parameters>
            </operation>

            <operation
               name="removeRole"
               description="Remove the specified Role from the User.">
               <parameters>
                  <c:simple-property
                     name="rolename"
                     displayName="Role Name"
                     description="The Role to remove."
                     type="string"
                     required="true" />
               </parameters>
            </operation>

            <metric
               property="Users:type=User,username=%username%,database=UserDatabase:roles"
               displayName="Roles"
               defaultOn="true"
               dataType="trait" />

            <metric
               property="Users:type=User,username=%username%,database=UserDatabase:groups"
               displayName="Groups"
               defaultOn="true"
               dataType="trait" />

            <resource-configuration>
               <c:group name="Attributes">
                  <c:simple-property
                     name="fullName"
                     required="false"
                     description="The full name of User" />
                  <c:simple-property
                     name="password"
                     type="password"
                     required="false"
                     description="The credentials used to authenticate the username." />
               </c:group>
            </resource-configuration>
         </service>

      </service>

   </server>

</plugin>
